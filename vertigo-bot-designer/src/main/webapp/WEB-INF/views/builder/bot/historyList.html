<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:vu="http://www.morphbit.com/thymeleaf/component"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{templates/botDetailLayout}" th:with="tab=history"
>

    <head>
        <title th:text="#{history.title}"></title>
        <script th:src="@{/static/utils/moment.min.js}"></script>
        <script th:inline="javascript">

            function normalizeString(str) {
                if (str)
                    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toLowerCase();
                else
                    return '';
            }

            
            function filterHistory(historyList) {
                let historyListFiltered = historyList;
                let criteria = VertigoUi.vueData.criteria;

                if (criteria.hacCd !== null)  {
                    historyListFiltered = historyListFiltered.slice().reverse().filter(history =>
                        history.hacCd === criteria.hacCd
                    );
                }

                if (criteria.fromDate !== null && criteria.fromDate !== '') {
                    let dateFrom = moment(criteria.fromDate, 'DD/MM/YYYY');
                    historyListFiltered = historyListFiltered.slice().reverse().filter(history => {
                        let historyDate = moment(history.date.substr(0,10), 'DD/MM/YYYY');
                        return historyDate.isSameOrAfter(dateFrom);
                    });
                }

                if (criteria.toDate !== null && criteria.toDate !== '') {
                    let toDate = moment(criteria.toDate, 'DD/MM/YYYY');
                    historyListFiltered = historyListFiltered.slice().reverse().filter(history => {
                        let historyDate = moment(history.date.substr(0,10), 'DD/MM/YYYY');
                        return historyDate.isSameOrBefore(toDate);
                    });
                }

                let searchNormarlized = normalizeString(criteria.text);
                if (searchNormarlized !==''){
                    historyListFiltered = historyListFiltered
                        // copy and reverse
                        .slice().reverse()
                        // search
                        .filter(history => normalizeString(history.className).includes(searchNormarlized) ||
                            normalizeString(history.userName).includes(searchNormarlized) || normalizeString(history.message).includes(searchNormarlized))
                }
                
                return historyListFiltered;
            }

            function getHistoryActionLabel(action) {
                let historyAction = VertigoUi.vueData.historyActions.find(currentAction => currentAction.hacCd === action);
                if (historyAction !== undefined) {
                    return VertigoUi.vueData.locale === 'fr_FR' ? historyAction.labelFr : historyAction.label;
                } else {
                    return action;
                }
            }

        </script>
    </head>

    <body>

        <section layout:fragment="content">

            <vu:table th:title="#{history.table.title}" list="historyList" transformFunction="filterHistory" componentId="historyList" sortBy="date" descending :binary-state-sort="true">
                <vu:slot name="top_right_slot">
                    <vu:select-edit object="criteria" field="hacCd"
                    				list="historyActions" labelField="${model.locale == 'fr_FR' ? 'labelFr' : 'label'}"
                    				label="#{history.selection.action}" clearable style="width: 250px; margin-right: 10px"/>

                    <vu:date-edit object="criteria" field="fromDate" label="#{history.date.from}" clearable @clear="vueData.criteria.fromDate=null" style="width:210px; margin-right: 10px"/>
                    <vu:date-edit object="criteria" field="toDate" label="#{history.date.to}" clearable @clear="vueData.criteria.toDate=null" style="width:210px; margin-right: 10px"/>
                    
                    <vu:text-field-edit object="criteria" field="text" label="#{history.search}" clearable debounce="300" style="width:210px"/>
                    <q-icon name="search" class="q-field__marginal" ></q-icon>

                </vu:slot>
                <vu:include-data object="historyList" field="'*'" />
                <vu:include-data-primitive key="locale"/>
                <vu:column field="date"/>
                <vu:column field="hacCd">
                    <vu:content>
                        <span v-html="getHistoryActionLabel(props.row.hacCd)"></span>
                    </vu:content>
                </vu:column>
                <vu:column field="className">
                    <vu:content>
                        <span th:text="#{history.training}" v-if="props.row.className == 'Training'"></span>
                        <span th:text="#{history.scriptIntention}" v-else-if="props.row.className == 'ScriptIntention'"></span>
                        <span th:text="#{history.smalltalk}" v-else-if="props.row.className == 'SmallTalk'"></span>
                        <span th:text="#{history.dictionaryEntity}" v-else-if="props.row.className == 'DictionaryEntity'"></span>
                        <span th:text="#{history.contextValue}" v-else-if="props.row.className == 'ContextValue'"></span>
                        <span th:text="#{history.profile}" v-else-if="props.row.className == 'ProfilPerChatbot'"></span>
                        <span v-else>{{props.row.className}}</span>
                    </vu:content>
                </vu:column>
                <vu:column field="message"/>
                <vu:column field="userName"/>
            </vu:table>
        </section>
        <section layout:fragment="javascript-footer" >
            <script type="text/javascript">
                VUiPage.$data.componentStates.historyList.columns[0].sort = VertigoUi.methods.sortDatesAsString("DD/MM/YYYY HH:mm");
            </script>
        </section>
    </body>
</html>