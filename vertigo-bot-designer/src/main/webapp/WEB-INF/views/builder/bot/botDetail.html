<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org" 
	xmlns:vu="http://www.morphbit.com/thymeleaf/component"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{templates/botDetailLayout}" th:with="nav=true, tab=informations, noNavigation=${model.modeCreate}"
	>
	
	<head>
		<title th:text="#{bot.detail.title}"></title>

		<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
		<script th:src="@{/static/js/c-richtext.js}"></script>
		<script th:src="@{/static/js/c-buttonList.js}"></script>
		
		<!-- CDNJS :: Sortable (https://cdnjs.com/) -->
		<script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
		<!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
		<script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/codemirror.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/mode/javascript/javascript.min.js"></script>
		<script src="//cdn.jsdelivr.net/npm/vue-codemirror"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/addon/mode/simple.min.js" integrity="sha512-9YoNYsegWvbA5aiSshQ2BNW2FAq3CQVLqpg2r6urw9Tfl1GklM9PNgrMRVz8fhEtjM+uZfO/1X3RURkMcil8wg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/addon/hint/show-hint.min.js" integrity="sha512-kCn9g92k3GM90eTPGMNwvpCAtLmvyqbpvrdnhm0NMt6UEHYs+DjRO4me8VcwInLWQ9azmamS1U1lbQV627/TBQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
 		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/addon/hint/show-hint.min.css" integrity="sha512-OmcLQEy8iGiD7PSm85s06dnR7G7C9C0VqahIPAj/KHk5RpOCmnC6R2ob1oK4/uwYhWa9BF1GC6tzxsC8TIx7Jg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/codemirror.min.css" />
		<script th:src="@{/static/chatbot/chatbotMode.js}"></script>
		<script th:src="@{/static/js/c-codemirror.js}"></script>
		<script th:inline="javascript">
		 	Vue.use(window.VueCodemirror)
			function getChatPreview() {
				return [VertigoUi.vueData.chatbotCustomConfig.fontFamily];
			}
			function changeChatMessageBgColor() {
				 Array.from(document.getElementsByClassName('q-message-text--received')).forEach(function (element, index, array) {
					 element.style.setProperty('--chat-message-bg-color', VertigoUi.vueData.chatbotCustomConfig.backgroundColor);
				 });
			}

			function changeChatMessageFontFamily() {
				Array.from(document.getElementsByClassName('q-message-text--received')).forEach(function (element, index, array) {
					element.style.setProperty('--chat-message-font-family', VertigoUi.vueData.chatbotCustomConfig.fontFamily);
				});
			}

			document.addEventListener('DOMContentLoaded', function () {
				changeChatMessageBgColor();
				changeChatMessageFontFamily();
			});
		</script>
		<style>
			.q-message-text--received {
				color: var(--chat-message-bg-color) !important;
				font-family: var(--chat-message-font-family) !important;
			}
		</style>
	</head>
	
	<body>
		<div layout:fragment="content-header-left" id="baseImg"  class="row items-center header-bot-img">
	 		<img v-if="componentStates.uploaderbotTmpPictureUri && componentStates.uploaderbotTmpPictureUri.fileUris.length > 0" th::src="|'@{/commons/upload}?file=' + componentStates.uploaderbotTmpPictureUri.fileUris[0]|"/>
	 		<img v-if="!componentStates.uploaderbotTmpPictureUri || componentStates.uploaderbotTmpPictureUri.fileUris.length == 0" th:src="@{/bot/{id}/avatar(id=${model.bot.botId})}" />
		</div>
	
		<section layout:fragment="content-actions">
			<vu:button-link th:if="${model.modeEdit}" url="@{/bot/{id}(id=${model.bot.botId})}" th:ariaLabel="#{bot.cancel}" icon="fas fa-ban"
							class="on-left text-accent-inverted" :round size="md" color="primary" :flat />
			<vu:button-submit th:if="${model.modeReadOnly && model.userAuthorizations[AtzChatbot$botAdm]}" action="@{_edit}" th:ariaLabel="#{bot.edit}" icon="edit"
							class="on-left" :round size="md" color="primary" />
		</section>
		
		<section layout:fragment="content">
			<div class="text-primary text-h6 text-weight-bold" th:text="#{layout.information}"></div>
			<vu:block id="identity" th:title="#{bot.identity}">
				<vu:text-field object="bot" field="name" th:if="${viewMode=='edit'}"/>
				
				<vu:label-edit object="bot" field="filIdAvatar" th:if="${viewMode=='edit'}">
					<vu:fileupload th:url="'@{/commons/upload}'" key="botTmpPictureUri" multiple="false"/>
				</vu:label-edit>
				<vu:include-data object="chatbotCustomConfig" field="displayAvatar" modifiable="true" />
				<vu:label-edit object="chatbotCustomConfig" field="displayAvatar" th:if="${viewMode=='edit'}">
					<q-toggle left-label th:label="#{bot.avatar.display}" v-model="vueData.chatbotCustomConfig.displayAvatar" th::disable="${model.modeReadOnly}"></q-toggle>
					<input type="hidden" name="vContext[chatbotCustomConfig][displayAvatar]" :value="vueData.chatbotCustomConfig.displayAvatar"/>
				</vu:label-edit>
				
				<vu:text-area object="bot" field="description"/>
			</vu:block>
			
			<vu:include-data-primitive key="locale"/>
			<vu:include-data object="typeTopicList" field="'*'" />
			
			<vu:block id="welcome" th:title="#{bot.welcome}">
				<vu:include-data object="startTopic" field="ttoCd" modifiable="true"/>
				<vu:include-data object="startTopic" field="value" modifiable="true"/>
				
				<div>				
				   <q-btn-toggle
				      th:if="${!model.modeReadOnly}"
				        v-model="vueData.startTopic.ttoCd"
				        toggle-color="primary"
				        :options="vueData.locale == 'fr_FR' ? transformListForSelection('typeTopicList', 'ttoCd', 'labelFr') : transformListForSelection('typeTopicList', 'ttoCd', 'label')"
						th::mode-edit="${!model.modeReadOnly}"
				      />
			    </div>
			    <input type="hidden" name="vContext[startTopic][ttoCd]" :value="vueData.startTopic.ttoCd" />
			    <div v-if="vueData.startTopic.ttoCd == 'SMALLTALK'">
					<c-richtext 
						class="q-py-sm"
						v-model="vueData.startTopic.value"
						name="vContext[startTopic][value]"
						:error="hasFieldsError('startTopic', 'value')"
						:locale="vueData.locale"
						th::mode-edit="${!model.modeReadOnly}">
					</c-richtext>
				</div>
				<div v-else>
					<c-codemirror
						object="startTopic"
						field="value"
						:error="hasFieldsError('startTopic', 'value')"
						:locale="vueData.locale"
						th::mode-edit="${!model.modeReadOnly}">
					</c-codemirror>
				</div>
				
				<div v-if="hasFieldsError('startTopic', 'value')" class="text-red">{{getErrorMessage('startTopic', 'value')}}</div>
			</vu:block>
			
			<vu:block id="fallback" th:title="'#{bot.fallback}'">
				<vu:include-data object="failureTopic" field="ttoCd" modifiable="true"/>
				<vu:include-data object="failureTopic" field="value" modifiable="true"/>
				
				<div>				
					<q-btn-toggle
				      	th:if="${!model.modeReadOnly}"
				        v-model="vueData.failureTopic.ttoCd"
				        toggle-color="primary"
				        :options="vueData.locale == 'fr_FR' ? transformListForSelection('typeTopicList', 'ttoCd', 'labelFr') : transformListForSelection('typeTopicList', 'ttoCd', 'label')"
				      	th::mode-edit="${!model.modeReadOnly}"
				     />
			    </div>
			    <input type="hidden" name="vContext[failureTopic][ttoCd]" :value="vueData.failureTopic.ttoCd" />
			    <div v-if="vueData.failureTopic.ttoCd == 'SMALLTALK'">
					<c-richtext 
						class="q-py-sm"
						v-model="vueData.failureTopic.value"
						name="vContext[failureTopic][value]"
						:error="hasFieldsError('failureTopic', 'value')"
						:locale="vueData.locale"
						th::mode-edit="${!model.modeReadOnly}">
					</c-richtext>
				</div>
				<div v-else>
					<c-codemirror
						object="failureTopic"
						field="value"
						:error="hasFieldsError('failureTopic', 'value')"
						:locale="vueData.locale"
						th::mode-edit="${!model.modeReadOnly}">
					</c-codemirror>
				</div>
				
				<div v-if="hasFieldsError('failureTopic', 'value')" class="text-red">{{getErrorMessage('failureTopic', 'value')}}</div>
			</vu:block>
			
			<vu:block id="end" th:title="#{bot.end}">
				<vu:include-data object="endTopic" field="ttoCd" modifiable="true"/>
				<vu:include-data object="endTopic" field="value" modifiable="true"/>
				
				<div>				
					<q-btn-toggle
				      	th:if="${!model.modeReadOnly}"
				        v-model="vueData.endTopic.ttoCd"
				        toggle-color="primary"
				        :options="vueData.locale == 'fr_FR' ? transformListForSelection('typeTopicList', 'ttoCd', 'labelFr') : transformListForSelection('typeTopicList', 'ttoCd', 'label')"
				      	th::mode-edit="${!model.modeReadOnly}"
					/>
			    </div>
			    <input type="hidden" name="vContext[endTopic][ttoCd]" :value="vueData.endTopic.ttoCd" />
			    <div v-if="vueData.endTopic.ttoCd == 'SMALLTALK'">
					<c-richtext	
						class="q-py-sm"
						v-model="vueData.endTopic.value"
						name="vContext[endTopic][value]"
						:error="hasFieldsError('endTopic', 'value')"
						:locale="vueData.locale"
						th::mode-edit="${!model.modeReadOnly}">
					</c-richtext>
				</div>
				<div v-else>
					<c-codemirror
						object="endTopic"
						field="value"
						:error="hasFieldsError('endTopic', 'value')"
						:locale="vueData.locale"
						th::mode-edit="${!model.modeReadOnly}">
					</c-codemirror>
				</div>
				
				<div v-if="hasFieldsError('endTopic', 'value')" class="text-red">{{getErrorMessage('endTopic', 'value')}}</div>
			</vu:block>
			<vu:block id="idle" th:title="#{bot.idle}">
				<vu:include-data object="idleTopic" field="value" modifiable="true" />
				<c-codemirror
						object="idleTopic"
						field="value"
						:error="hasFieldsError('idleTopic', 'value')"
						th::mode-edit="${!model.modeReadOnly}">
				</c-codemirror>

				<div v-if="hasFieldsError('idleTopic', 'value')" class="text-red">{{getErrorMessage('idleTopic', 'value')}}</div>
			</vu:block>
			<vu:block id="rating" th:title="#{bot.rating}">
				<vu:include-data object="chatbotCustomConfig" field="rating" modifiable="true" />
				<vu:include-data object="chatbotCustomConfig" field="ratingMessage" modifiable="true" />
				<vu:include-data object="chatbotCustomConfig" field="botEmailAddress" modifiable="true" />
				<vu:include-data object="chatbotCustomConfig" field="reinitializationButton" modifiable="true" />
				<vu:include-data object="chatbotCustomConfig" field="backgroundColor" modifiable="true" />
				<vu:include-data object="chatbotCustomConfig" field="fontFamily" modifiable="true" />
				<vu:include-data object="chatbotCustomConfig" field="displayAvatar" modifiable="true" />

				<q-toggle left-label th:label="#{bot.rating.activate}" v-model="vueData.chatbotCustomConfig.rating" th::disable="${model.modeReadOnly}"></q-toggle>
				<input type="hidden" name="vContext[chatbotCustomConfig][rating]" :value="vueData.chatbotCustomConfig.rating"/>
				<q-input v-model="vueData.chatbotCustomConfig.ratingMessage"  :error="hasFieldsError('chatbotCustomConfig', 'ratingMessage')"
						 :error-message="getErrorMessage('chatbotCustomConfig', 'ratingMessage')" name="vContext[chatbotCustomConfig][ratingMessage]" th:label="#{bot.rating.message}" th::disable="${model.modeReadOnly}" />
			</vu:block>
			<vu:block id="botEmail" th:title="#{bot.email.address}">
				<q-input v-model="vueData.chatbotCustomConfig.botEmailAddress" :error="hasFieldsError('chatbotCustomConfig', 'botEmailAddress')"
						 :error-message="getErrorMessage('chatbotCustomConfig', 'botEmailAddress')"  name="vContext[chatbotCustomConfig][botEmailAddress]"
						 th:label="#{bot.email.address}" th::disable="${model.modeReadOnly}" />
			</vu:block>
			<vu:block id="reinitialization" th:title="#{bot.reinitialization}">
				<q-toggle left-label th:label="#{bot.reinitialization.active}" v-model="vueData.chatbotCustomConfig.reinitializationButton" th::disable="${model.modeReadOnly}"></q-toggle>
				<input type="hidden" name="vContext[chatbotCustomConfig][reinitializationButton]" :value="vueData.chatbotCustomConfig.reinitializationButton"/>
			</vu:block>
			<vu:block id="botStyling" th:title="#{bot.styling}">

				<div style="width:300px" class="q-px-md">
					<q-chat-message :sent="false" :text="getChatPreview()" text-color="black" :bg-color="vueData.chatbotCustomConfig.backgroundColor" >

					</q-chat-message>
				</div>

				<q-select style="margin-bottom: 20px;"
						v-model="vueData.chatbotCustomConfig.fontFamily" name="vContext[chatbotCustomConfig][fontFamily]" th:label="#{bot.styling.font.family}"
						@input="changeChatMessageFontFamily()"
					  	th::disable="${model.modeReadOnly}"
						:options="['Arial, sans-serif', 'Verdana, sans-serif', 'Helvetica, sans-serif', 'Tahoma, sans-serif',
						'Trebuchet MS, sans-serif', 'Times New Roman, serif', 'Georgia, serif', 'Garamond, serif', 'Courier New, monospace', 'Brush Script MT, cursive']">

				</q-select>
				<q-color th::disable="${model.modeReadOnly}" v-model="vueData.chatbotCustomConfig.backgroundColor" @change="function (event) { changeChatMessageBgColor() }" default-value="#000000" name="vContext[chatbotCustomConfig][backgroundColor]"/>

			</vu:block>
			<vu:block id="attachments" th:title="#{bot.attachments}">
				<vu:include-data object="chatbotCustomConfig" field="totalMaxAttachmentSize" modifiable="true" />
				<q-input type="number" v-model="vueData.chatbotCustomConfig.totalMaxAttachmentSize"  :error="hasFieldsError('chatbotCustomConfig', 'totalMaxAttachmentSize')"
						 :error-message="getErrorMessage('chatbotCustomConfig', 'totalMaxAttachmentSize')" name="vContext[chatbotCustomConfig][totalMaxAttachmentSize]"
						 th:label="#{bot.attachments.maxsize.label}" th::disable="${model.modeReadOnly}" />
			</vu:block>

			<q-page-sticky position="bottom-right">
				<vu:button-submit th:if="${!model.modeReadOnly}" icon="save" th:label="#{action.save}" action="@{_save}" size="lg" color="primary" /> 
			</q-page-sticky>
		</section>
		
	</body>
</html>